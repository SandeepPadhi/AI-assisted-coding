{% extends "base.html" %}

{% block title %}Dashboard - Chat App{% endblock %}

{% block content %}
<div class="row">
            <!-- Recent Messages -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Recent Messages</h5>
                <span class="badge bg-primary" id="message-count">{{ recent_messages|length }}</span>
            </div>
            <div class="card-body">
                <div id="messages-container">
                    {% if recent_messages %}
                        <div class="list-group list-group-flush" id="messages-list">
                            {% for message in recent_messages %}
                                <div class="list-group-item px-0 message-item" data-message-id="{{ message.message_id }}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center mb-1">
                                                {% if message.sender_id == session.user_id %}
                                                    <strong>You</strong>
                                                    <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                                    <span>{{ message.receiver_name or 'Unknown' }}</span>
                                                {% else %}
                                                    <span>{{ message.sender_name or 'Unknown' }}</span>
                                                    <i class="fas fa-arrow-right mx-2 text-muted"></i>
                                                    <strong>You</strong>
                                                {% endif %}
                                            </div>
                                            <p class="text-muted mb-1 small message-content">{{ message.content }}</p>
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i> <span class="message-time">{{ message.created_at | datetime }}</span>
                                                {% if message.status == 'edited' %}
                                                    <span class="badge bg-warning ms-1">Edited</span>
                                                {% elif message.status == 'deleted' %}
                                                    <span class="badge bg-danger ms-1">Deleted</span>
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="ms-3">
                                            {% if message.sender_id == session.user_id %}
                                                <a href="{{ url_for('chat_with_user', user_id=message.receiver_id) }}"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-reply"></i>
                                                </a>
                                            {% else %}
                                                <a href="{{ url_for('chat_with_user', user_id=message.sender_id) }}"
                                                   class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-reply"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5" id="no-messages">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No messages yet</h5>
                            <p class="text-muted">Start a conversation with someone!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Quick Actions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('users') }}" class="btn btn-primary">
                        <i class="fas fa-users"></i> Find Users
                    </a>
                    <a href="{{ url_for('groups') }}" class="btn btn-success">
                        <i class="fas fa-user-friends"></i> Create Group
                    </a>
                </div>
            </div>
        </div>

        <!-- Online Contacts -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-circle text-success"></i> Contacts</h6>
                <span class="badge bg-success">{{ contacts|length }}</span>
            </div>
            <div class="card-body p-0">
                {% if contacts %}
                    <div class="list-group list-group-flush">
                        {% for contact in contacts %}
                            <a href="{{ url_for('chat_with_user', user_id=contact.user_id) }}"
                               class="list-group-item list-group-item-action d-flex align-items-center">
                                <div class="flex-grow-1">
                                    <strong>{{ contact.username }}</strong>
                                    <br>
                                    <small class="text-muted">Joined {{ contact.created_at | date }}</small>
                                </div>
                                <i class="fas fa-chevron-right text-muted"></i>
                            </a>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="p-3 text-center text-muted">
                        <small>No other users yet</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Real-time message updates
    let lastUpdateTime = new Date(Date.now() - 60000).toISOString(); // Start from 1 minute ago
    let isUpdating = false;

    // Function to check for new messages
    function checkForNewMessages() {
        if (isUpdating) return;

        isUpdating = true;

        fetch(`/api/new_messages?since=${encodeURIComponent(lastUpdateTime)}`)
            .then(response => response.json())
            .then(data => {
                if (data.messages && data.messages.length > 0) {
                    updateMessages(data.messages);
                    updateMessageCount();
                    lastUpdateTime = new Date().toISOString();
                }
            })
            .catch(error => {
                console.error('Error checking for new messages:', error);
            })
            .finally(() => {
                isUpdating = false;
            });
    }

    // Function to update the messages display
    function updateMessages(newMessages) {
        const messagesList = document.getElementById('messages-list');
        const noMessagesDiv = document.getElementById('no-messages');

        // Hide no messages div if it exists and we have messages
        if (noMessagesDiv && newMessages.length > 0) {
            noMessagesDiv.style.display = 'none';
        }

        // Create messages list if it doesn't exist
        if (!messagesList) {
            const container = document.getElementById('messages-container');
            const newList = document.createElement('div');
            newList.className = 'list-group list-group-flush';
            newList.id = 'messages-list';
            container.appendChild(newList);
        }

        // Add new messages to the top
        newMessages.forEach(message => {
            addMessageToTop(message);
        });

        // Show a subtle notification
        showUpdateNotification(newMessages.length);
    }

    // Function to add a message to the top of the list
    function addMessageToTop(message) {
        const messagesList = document.getElementById('messages-list');
        if (!messagesList) return;

        // Check if message already exists
        const existingMessage = messagesList.querySelector(`[data-message-id="${message.message_id}"]`);
        if (existingMessage) {
            // Update existing message
            updateExistingMessage(existingMessage, message);
            return;
        }

        // Create new message element
        const messageElement = document.createElement('div');
        messageElement.className = 'list-group-item px-0 message-item';
        messageElement.setAttribute('data-message-id', message.message_id);

        const currentUserId = '{{ session.user_id }}';

        messageElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-1">
                        ${message.sender_id === currentUserId ?
                            '<strong>You</strong><i class="fas fa-arrow-right mx-2 text-muted"></i><span>' + (message.receiver_name || 'Unknown') + '</span>' :
                            '<span>' + (message.sender_name || 'Unknown') + '</span><i class="fas fa-arrow-right mx-2 text-muted"></i><strong>You</strong>'
                        }
                    </div>
                    <p class="text-muted mb-1 small message-content">${message.content}</p>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> <span class="message-time">Just now</span>
                        ${message.status === 'edited' ? '<span class="badge bg-warning ms-1">Edited</span>' : ''}
                        ${message.status === 'deleted' ? '<span class="badge bg-danger ms-1">Deleted</span>' : ''}
                    </small>
                </div>
                <div class="ms-3">
                    <a href="/chat/${message.sender_id === currentUserId ? message.receiver_id : message.sender_id}"
                       class="btn btn-sm btn-outline-${message.sender_id === currentUserId ? 'primary' : 'success'}">
                        <i class="fas fa-reply"></i>
                    </a>
                </div>
            </div>
        `;

        // Add to top of list
        messagesList.insertBefore(messageElement, messagesList.firstChild);
    }

    // Function to update existing message
    function updateExistingMessage(element, message) {
        const contentElement = element.querySelector('.message-content');
        const timeElement = element.querySelector('.message-time');

        if (contentElement) {
            contentElement.textContent = message.content;
        }

        if (timeElement) {
            timeElement.textContent = 'Updated';
        }

        // Add/update status badges
        let statusContainer = element.querySelector('.status-badges');
        if (!statusContainer) {
            statusContainer = document.createElement('span');
            statusContainer.className = 'status-badges ms-1';
            timeElement.parentNode.appendChild(statusContainer);
        }

        statusContainer.innerHTML = message.status === 'edited' ? '<span class="badge bg-warning">Edited</span>' :
                                   message.status === 'deleted' ? '<span class="badge bg-danger">Deleted</span>' : '';
    }

    // Function to update message count
    function updateMessageCount() {
        const messageCountElement = document.getElementById('message-count');
        const messageItems = document.querySelectorAll('.message-item');

        if (messageCountElement) {
            messageCountElement.textContent = messageItems.length;
        }
    }

    // Function to show update notification
    function showUpdateNotification(count) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show position-fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '250px';

        notification.innerHTML = `
            <i class="fas fa-bell"></i> ${count} new message${count > 1 ? 's' : ''} received!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }

    // Start polling for new messages every 5 seconds
    setInterval(checkForNewMessages, 5000);

    // Initial check for new messages (in case page was loaded while offline)
    setTimeout(checkForNewMessages, 1000);

    console.log('ðŸš€ Real-time message updates enabled!');
});
</script>
{% endblock %}
