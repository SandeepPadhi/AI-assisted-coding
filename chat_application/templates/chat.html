{% extends "base.html" %}

{% block title %}Chat with {{ target_user.username }} - Chat App{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Chat Header -->
        <div class="card mb-3">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-user-circle fa-2x text-primary me-3"></i>
                <div>
                    <h5 class="mb-0">{{ target_user.username }}</h5>
                    <small class="text-muted">Member since {{ target_user.created_at | date }}</small>
                </div>
                <div class="ms-auto">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-comments"></i> Conversation</h6>
            </div>
            <div class="card-body p-0">
                <div id="messages-container" class="chat-messages p-3">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="message-wrapper mb-3 {% if message.is_sender %}text-end{% endif %} message-item" data-message-id="{{ message.message_id }}">
                                <div class="message-bubble {% if message.is_sender %}message-sent{% else %}message-received{% endif %}">
                                    <div class="message-content">{{ message.content }}</div>
                                    <div class="message-meta">
                                        <small class="text-muted">
                                            {{ message.created_at | datetime }}
                                            {% if message.status == 'edited' %}
                                                <span class="badge bg-warning ms-1">Edited</span>
                                            {% elif message.status == 'deleted' %}
                                                <span class="badge bg-danger ms-1">Deleted</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                </div>
                                {% if message.is_sender %}
                                    <div class="message-actions mt-1">
                                        <button class="btn btn-sm btn-outline-primary edit-btn"
                                                data-message-id="{{ message.message_id }}"
                                                data-content="{{ message.content }}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                                data-message-id="{{ message.message_id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No messages yet</h5>
                            <p class="text-muted">Start the conversation!</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Message Input -->
            <div class="card-footer">
                <form id="message-form" class="d-flex gap-2">
                    <input type="hidden" name="receiver_id" value="{{ target_user.user_id }}">
                    <input type="text"
                           id="message-input"
                           name="content"
                           class="form-control"
                           placeholder="Type your message..."
                           maxlength="1000"
                           required>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                        <span class="d-none d-sm-inline ms-1">Send</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit Message Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="edit-form">
                <div class="modal-body">
                    <input type="hidden" id="edit-message-id" name="message_id">
                    <div class="mb-3">
                        <label for="edit-content" class="form-label">Message</label>
                        <textarea class="form-control"
                                  id="edit-content"
                                  name="content"
                                  rows="3"
                                  maxlength="1000"
                                  required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this message? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirm-delete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const messagesContainer = document.getElementById('messages-container');

    // Real-time updates for chat conversation
    let lastMessageTime = new Date().toISOString();
    let isCheckingMessages = false;

    // Send message
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const content = formData.get('content').trim();

        if (!content) return;

        fetch('/send_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                receiver_id: formData.get('receiver_id'),
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add message to UI
                addMessageToUI(data.message);
                messageInput.value = '';
                scrollToBottom();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to send message');
        });
    });

    // Edit message
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-btn') || e.target.closest('.edit-btn')) {
            const btn = e.target.classList.contains('edit-btn') ? e.target : e.target.closest('.edit-btn');
            const messageId = btn.dataset.messageId;
            const content = btn.dataset.content;

            document.getElementById('edit-message-id').value = messageId;
            document.getElementById('edit-content').value = content;

            new bootstrap.Modal(document.getElementById('editModal')).show();
        }
    });

    // Save edited message
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const messageId = formData.get('message_id');
        const content = formData.get('content').trim();

        fetch('/edit_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message_id: messageId,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                location.reload(); // Simple reload to update UI
            } else {
                alert('Error: ' + data.error);
            }
        });
    });

    // Delete message
    let messageToDelete = null;
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-btn') || e.target.closest('.delete-btn')) {
            const btn = e.target.classList.contains('delete-btn') ? e.target : e.target.closest('.delete-btn');
            messageToDelete = btn.dataset.messageId;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        }
    });

    // Confirm delete
    document.getElementById('confirm-delete').addEventListener('click', function() {
        if (!messageToDelete) return;

        fetch('/delete_message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message_id: messageToDelete
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    });

    function addMessageToUI(message) {
        const messageHTML = `
            <div class="message-wrapper mb-3 text-end">
                <div class="message-bubble message-sent">
                    <div class="message-content">${message.content}</div>
                    <div class="message-meta">
                        <small class="text-muted">
                            ${new Date().toLocaleTimeString()}
                        </small>
                    </div>
                </div>
            </div>
        `;
        messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
    }

    function scrollToBottom() {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Scroll to bottom on load
    scrollToBottom();

    // Function to check for new messages in this conversation
    function checkForNewChatMessages() {
        if (isCheckingMessages) return;

        isCheckingMessages = true;

        const targetUserId = '{{ target_user.user_id }}';

        fetch(`/api/messages/${targetUserId}`)
            .then(response => response.json())
            .then(data => {
                if (data.messages) {
                    updateChatMessages(data.messages);
                }
            })
            .catch(error => {
                console.error('Error checking for new messages:', error);
            })
            .finally(() => {
                isCheckingMessages = false;
            });
    }

    // Function to update chat messages
    function updateChatMessages(messages) {
        const currentMessageIds = new Set();
        document.querySelectorAll('.message-item').forEach(item => {
            currentMessageIds.add(item.dataset.messageId);
        });

        // Add any new messages
        messages.forEach(message => {
            if (!currentMessageIds.has(message.message_id)) {
                addNewChatMessage(message);
            }
        });
    }

    // Function to add a new message to the chat
    function addNewChatMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.className = `message-wrapper mb-3 ${message.is_sender ? 'text-end' : ''}`;
        messageElement.setAttribute('data-message-id', message.message_id);

        messageElement.innerHTML = `
            <div class="message-bubble ${message.is_sender ? 'message-sent' : 'message-received'}">
                <div class="message-content">${message.content}</div>
                <div class="message-meta">
                    <small class="text-muted">
                        Just now
                        ${message.status === 'edited' ? '<span class="badge bg-warning ms-1">Edited</span>' : ''}
                        ${message.status === 'deleted' ? '<span class="badge bg-danger ms-1">Deleted</span>' : ''}
                    </small>
                </div>
            </div>
        `;

        messagesContainer.appendChild(messageElement);
        scrollToBottom();
    }

    // Check for new messages every 3 seconds
    setInterval(checkForNewChatMessages, 3000);

    console.log('ðŸ’¬ Real-time chat updates enabled!');
});
</script>
{% endblock %}
